const { expect } = require("chai");
const { ethers } = require("hardhat");
const { tokens } = require("../utils/utils");

const TOKENS_100 = tokens(100);
const BIG_TREE_LEAFS = 1_099_511_627_776;
const SMALL_TREE_LEAFS = 16;

const getNodeAmount = async (sTree, node) => {
  return (await sTree.treeNode(node)).amount;
};

const prepareTree = async (ethers, leafs) => {
  const SEGMENTTREE = await ethers.getContractFactory("SegmentTree");
  let tree = await SEGMENTTREE.deploy(leafs);
  await tree.deployed();
  return tree;
};

describe("SegmentTree", () => {
  let sTree;
  describe.skip("Big tree", async () => {
    beforeEach(async () => {
      sTree = await prepareTree(ethers, BIG_TREE_LEAFS);
    });
    it("res", async () => {
      console.log("before add nextNode", (await sTree.nextNode()).toString());
      for (const iterator of Array(300).keys()) {
        await sTree.nodeAddLiquidity(TOKENS_100);
      }
      console.log("after  add nextNode", (await sTree.nextNode()).toString());
      await sTree.add(TOKENS_100);
    });
  });
  describe("small tree (16 leaves)", (async) => {
    beforeEach(async () => {
      sTree = await prepareTree(ethers, SMALL_TREE_LEAFS);
    });
    it("add liquidity to 7 leafs, top add 100, withdraw leaf", async () => {
      for (const i of Array(7).keys()) {
        await sTree.nodeAddLiquidity(TOKENS_100);
      }
      /*
        Segment tree structure after nodeAddLiquidity:
        +---------------------------------------------------------------------------------------------------------------+
        |                                                                    1(700)                                     |
        +-----------------------------------------------------------------------+---------------------------------------+
        |                                2(700)                                 |                   3                   |
        +-----------------------------------+---------------+-----------------------------------------------------------+
        |              4(400)               |              5(300)               |         6         |         7         |
        +-----------------+-----------------+-----------------+-----------------+---------+---------+---------+---------+
        |     8(200)      |     9(200)      |    10(200)      |    11(100)      |    12   |    13   |    14   |    15   |
        +--------+--------+--------+--------+--------+--------+--------+--------+----+----+----+----+----+----+----+----+
        | 16(100)| 17(100)| 18(100)| 19(100)| 20(100)| 21(100)| 22(100)|   23   | 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 |
        +--------+--------+--------+--------+--------+--------+--------+--------+----+----+----+----+----+----+----+----+
            100    100        100      100      100      100      100 
      */

      expect(await getNodeAmount(sTree, 1)).to.be.equal(tokens(700));
      expect(await getNodeAmount(sTree, 2)).to.be.equal(tokens(700));
      expect(await getNodeAmount(sTree, 4)).to.be.equal(tokens(400));
      expect(await getNodeAmount(sTree, 5)).to.be.equal(tokens(300));
      expect(await getNodeAmount(sTree, 8)).to.be.equal(tokens(200));
      expect(await getNodeAmount(sTree, 9)).to.be.equal(tokens(200));
      expect(await getNodeAmount(sTree, 10)).to.be.equal(tokens(200));
      expect(await getNodeAmount(sTree, 11)).to.be.equal(tokens(100));

      await sTree.add(TOKENS_100);
      /*
        Segment tree structure after add(TOKENS_100) on top 1:
        +--------------------------------------------------------------------------------------------------------------------+
        |                                                                         1(800)                                     |
        +----------------------------------------------------------------------------+---------------------------------------+
        |                                2(800)                                      |                   3                   |
        +-----------------------------------+----------------------------------------+-------------------+-------------------+
        |              4(457.1428)          |               5(342.8571)              |         6         |         7         |
        +-----------------+-----------------+-----------------+----------------------+---------+---------+---------+---------+
        |     8(200)      |     9(200)      |    10(228.5714) |      11(114.2857)    |    12   |    13   |    14   |    15   |
        +--------+--------+--------+--------+--------+--------+-------------+--------+----+----+----+----+----+----+----+----+
        | 16(100)| 17(100)| 18(100)| 19(100)| 20(100)| 21(100)| 22(114.2857)|   23   | 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 |
        +--------+--------+--------+--------+--------+--------+-------------+--------+----+----+----+----+----+----+----+----+
            100    100        100      100      100      100      100 

        100 tokens been spread for nodes:
        4   - 57.142857142800000000   100 * 400 / (400+300)
        10  - 28.571428571371428571   (100 - 57.1428) * 200 / (200 + 100)
        22  - 14.285714285685714285   (100 - 57.1428) * 100 / (200 + 100)
        57.142857142800000000 + 28.571428571371428571 + 14.285714285685714285 = 99.999999999857142856

      */

      expect((await sTree.treeNode(4)).amount).to.be.equal("457142857142800000000");
      expect((await sTree.treeNode(10)).amount).to.be.equal("228571428571371428571");
      expect((await sTree.treeNode(22)).amount).to.be.equal("114285714285685714285");

      await sTree.nodeWithdrawLiquidity(16);

      /*
        Segment tree structure after nodeWithdrawLiquidity(16):
        +--------------------------------------------------------------------------------------------------------------------+
        |                                                                         1(700)                                     |
        +----------------------------------------------------------------------------+---------------------------------------+
        |                                2(700)                                      |                   3                   |
        +-----------------------------------+----------------------------------------+-------------------+-------------------+
        |              4(342.8571)          |               5(342.8571)              |         6         |         7         |
        +-----------------+-----------------+-----------------+----------------------+---------+---------+---------+---------+
        |     8(114.2857) |     9(228.5714) |    10(228.5714) |      11(114.2857)    |    12   |    13   |    14   |    15   |
        +--------+--------+--------+--------+--------+--------+-------------+--------+----+----+----+----+----+----+----+----+
        | 16(0)  | 17(100)| 18(100)| 19(100)| 20(100)| 21(100)| 22(114.2857)|   23   | 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 |
        +--------+--------+--------+--------+--------+--------+-------------+--------+----+----+----+----+----+----+----+----+
                    100        100      100      100      100      100 
        
        withdrawn from leaf 16 114.2857142857

      */

      expect((await sTree.treeNode(4)).amount).to.be.equal("342857142857100000000");
      expect((await sTree.treeNode(8)).amount).to.be.equal("114285714285700000000");
      expect((await sTree.treeNode(9)).amount).to.be.equal("228571428571400000000");
      expect((await sTree.treeNode(16)).amount).to.be.equal("0");
    });
    it("add liquidity to 6 leafs, top add 100", async () => {
      for (const i of Array(6).keys()) {
        await sTree.nodeAddLiquidity(TOKENS_100);
      }
      /*
        Segment tree structure after nodeAddLiquidity:
        +---------------------------------------------------------------------------------------------------------------+
        |                                                                    1(600)                                     |
        +-----------------------------------------------------------------------+---------------------------------------+
        |                                2(600)                                 |                   3                   |
        +-----------------------------------+---------------+-----------------------------------------------------------+
        |              4(400)               |              5(200)               |         6         |         7         |
        +-----------------+-----------------+-----------------+-----------------+---------+---------+---------+---------+
        |     8(200)      |     9(200)      |    10(200)      |       11        |    12   |    13   |    14   |    15   |
        +--------+--------+--------+--------+--------+--------+--------+--------+----+----+----+----+----+----+----+----+
        | 16(100)| 17(100)| 18(100)| 19(100)| 20(100)| 21(100)|   22   |   23   | 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 |
        +--------+--------+--------+--------+--------+--------+--------+--------+----+----+----+----+----+----+----+----+
            100    100        100      100      100      100
      */
      expect(await getNodeAmount(sTree, 1)).to.be.equal(tokens(600));
      expect(await getNodeAmount(sTree, 2)).to.be.equal(tokens(600));
      expect(await getNodeAmount(sTree, 4)).to.be.equal(tokens(400));
      expect(await getNodeAmount(sTree, 5)).to.be.equal(tokens(200));
      expect(await getNodeAmount(sTree, 8)).to.be.equal(tokens(200));
      expect(await getNodeAmount(sTree, 9)).to.be.equal(tokens(200));
      expect(await getNodeAmount(sTree, 10)).to.be.equal(tokens(200));

      await sTree.add(TOKENS_100);
      /*
        Segment tree structure after nodeAddLiquidity:
        +---------------------------------------------------------------------------------------------------------------+
        |                                                                    1(700)                                     |
        +-----------------------------------------------------------------------+---------------------------------------+
        |                                2(700)                                 |                   3                   |
        +-----------------------------------+-----------------------------------+-------------------+-------------------+
        |              4(466.6666)          |             5(233.3333)           |         6         |         7         |
        +-----------------+-----------------+-----------------+-----------------+---------+---------+---------+---------+
        |     8(200)      |     9(200)      |   10(233.33333) |       11        |    12   |    13   |    14   |    15   |
        +--------+--------+--------+--------+--------+--------+--------+--------+----+----+----+----+----+----+----+----+
        | 16(100)| 17(100)| 18(100)| 19(100)| 20(100)| 21(100)|   22   |   23   | 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 |
        +--------+--------+--------+--------+--------+--------+--------+--------+----+----+----+----+----+----+----+----+
            100    100        100      100      100      100

        100 tokens been spread for nodes:
        4   - 66.666666666600000000   100 * 400 / (400+200)
        5   - 33.333333333300000000   100 * 200 / (400+200)
        466.666666666600000000 + 233.333333333300000000 = 699.9999999999
      */
      //console.log(1, (await sTree.treeNode(1)).amount.toString());
      /* for (const i of Array(SMALL_TREE_LEAFS * 2).keys()) {
        console.log(i, (await sTree.treeNode(i)).amount.toString());
      } */
      expect((await sTree.treeNode(4)).amount).to.be.equal("466666666666600000000");
      expect((await sTree.treeNode(10)).amount).to.be.equal("233333333333300000000");
      expect((await sTree.treeNode(22)).amount).to.be.equal("0");
    });
  });
});
